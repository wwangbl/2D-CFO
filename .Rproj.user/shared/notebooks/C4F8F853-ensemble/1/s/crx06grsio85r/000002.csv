"0","ensemble <- function(phi, p.true, ncohort=12, cohortsize=1, init.level.A=1, init.level.B=1, add.args=list(), prior_tox_a1, prior_tox_a2, prior.o, x0, stop, tox.range, seed=NULL){"
"0","  "
"0","  set.seed(seed)"
"0","  earlystop <- 0"
"0","  ndose.A <- length(p.true[,1])"
"0","  ndose.B <- length(p.true[1,])"
"0","  cidx.A <- init.level.A"
"0","  cidx.B <- init.level.B"
"0","  "
"0","  tys <- matrix(0, ndose.A, ndose.B) # number of responses for different doses."
"0","  tns <- matrix(0, ndose.A, ndose.B) # number of subject for different doses."
"0","  tover.doses <- matrix(0, ndose.A, ndose.B) # Whether each dose is overdosed or not, 1 yes"
"0","  "
"0","  pre <- preliminary(p.true, ndose.A, ndose.B, tys, tns, seed)"
"0","  cidx.A <- pre$position[1]"
"0","  cidx.B <- pre$position[2]"
"0","  tys <- pre$tys"
"0","  tns <- pre$tns"
"0","  ncohort <- ((ncohort*cohortsize) - sum(tns))%/%3 + 1"
"0","  "
"0","  dose1 <- which(tns==1,arr.ind = T)[,1]"
"0","  dose2 <- which(tns==1,arr.ind = T)[,2]"
"0","  toxicity1 <- c(rep(0,length(dose1)-1),1)"
"0","  "
"0","  y <- c(rep(0,(sum(tns)-1)),1)"
"0","  combos <- c(tys[,1][tys[,1]!=0],tys[,1][2:length(tys[,1])][tys[,1][2:length(tys[,1])]!=0])"
"0","  a <- matrix(1:15,3,5)"
"0","  "
"0","  for (i in 1:ncohort){"
"0","    "
"0","    pc <- p.true[cidx.A, cidx.B] "
"0","    "
"0","    # sample from current dose"
"0","    cres <- rbinom(cohortsize, 1, pc)"
"0","    "
"0","    # update results"
"0","    tys[cidx.A, cidx.B] <- tys[cidx.A, cidx.B] + sum(cres)"
"0","    tns[cidx.A, cidx.B] <- tns[cidx.A, cidx.B] + cohortsize"
"0","    "
"0","    y <- c(y,cres)"
"0","    combos <- c(combos,rep(a[cidx.A, cidx.B]),cohortsize)"
"0","    dose1 <- c(dose1,rep(cidx.A,cohortsize))"
"0","    dose2 <- c(dose2,rep(cidx.B,cohortsize))"
"0","    toxicity1 <- c(toxicity1, cres)"
"0","    "
"0","    cy <- tys[cidx.A, cidx.B]"
"0","    cn <- tns[cidx.A, cidx.B]"
"0","    "
"0","    add.args <- c(list(y=cy, n=cn, tys=tys, tns=tns, cidx.A=cidx.A, cidx.B=cidx.B), add.args)"
"0","    "
"0","    "
"0","    if (tover.doses[1,1] == 1){"
"0","      earlystop <- 1"
"0","      break()"
"0","    }"
"0","    "
"0","    if (cidx.A!=1 & cidx.B!=1 & cidx.A!=ndose.A & cidx.B!=ndose.B){"
"0","      # no boundary"
"0","      cys <- tys[(cidx.A-1):(cidx.A+1), (cidx.B-1):(cidx.B+1)]"
"0","      cns <- tns[(cidx.A-1):(cidx.A+1), (cidx.B-1):(cidx.B+1)]"
"0","      cover.doses <- tover.doses[(cidx.A-1):(cidx.A+1), (cidx.B-1):(cidx.B+1)]"
"0","    } else if (cidx.A==1 & cidx.B==1){"
"0","      # (1, 1)"
"0","      cys <- rbind(c(NA,NA,NA),cbind(c(NA,NA),tys[1:2,1:2]))"
"0","      cns <- rbind(c(NA,NA,NA),cbind(c(NA,NA),tns[1:2,1:2]))"
"0","      cover.doses <- rbind(c(NA,NA,NA),cbind(c(NA,NA),tover.doses[1:2,1:2]))"
"0","    } else if (cidx.A==ndose.A & cidx.B==ndose.B){"
"0","      # (nA, nB)"
"0","      cys <- rbind(cbind(tys[(cidx.A-1):cidx.A,(cidx.B-1):cidx.B],c(NA,NA)), c(NA,NA,NA))"
"0","      cns <- rbind(cbind(tns[(cidx.A-1):cidx.A,(cidx.B-1):cidx.B],c(NA,NA)), c(NA,NA,NA))"
"0","      cover.doses <- rbind(cbind(tover.doses[(cidx.A-1):cidx.A,(cidx.B-1):cidx.B],c(NA,NA)), c(NA,NA,NA))"
"0","    } else if (cidx.A==1 & cidx.B==ndose.B){"
"0","      # (1, nB) "
"0","      cys <- rbind(c(NA,NA,NA),cbind(tys[1:2,(cidx.B-1):cidx.B],c(NA,NA)))"
"0","      cns <- rbind(c(NA,NA,NA),cbind(tns[1:2,(cidx.B-1):cidx.B],c(NA,NA)))"
"0","      cover.doses <- rbind(c(NA,NA,NA),cbind(tover.doses[1:2,(cidx.B-1):cidx.B],c(NA,NA)))"
"0","    } else if (cidx.A==ndose.A & cidx.B==1){"
"0","      # (nA, 1) "
"0","      cys <- rbind(cbind(c(NA,NA), tys[(cidx.A-1):cidx.A,1:2]),c(NA,NA,NA))"
"0","      cns <- rbind(cbind(c(NA,NA), tns[(cidx.A-1):cidx.A,1:2]),c(NA,NA,NA))"
"0","      cover.doses <- rbind(cbind(c(NA,NA), tover.doses[(cidx.A-1):cidx.A,1:2]),c(NA,NA,NA))"
"0","    } else if (cidx.A==1 & cidx.B!=1){"
"0","      # (1, 2:(nB-1))"
"0","      cys <- rbind(c(NA,NA,NA), tys[1:2, (cidx.B-1):(cidx.B+1)])"
"0","      cns <- rbind(c(NA,NA,NA), tns[1:2, (cidx.B-1):(cidx.B+1)])"
"0","      cover.doses <- rbind(c(NA,NA,NA), tover.doses[1:2, (cidx.B-1):(cidx.B+1)])"
"0","    } else if (cidx.A!=1 & cidx.B==1){"
"0","      # (2:(nA-1), 1)"
"0","      cys <- cbind(c(NA,NA,NA), tys[(cidx.A-1):(cidx.A+1), 1:2])"
"0","      cns <- cbind(c(NA,NA,NA), tns[(cidx.A-1):(cidx.A+1), 1:2])"
"0","      cover.doses <- cbind(c(NA,NA,NA), tover.doses[(cidx.A-1):(cidx.A+1), 1:2])"
"0","    } else if (cidx.A==ndose.A & cidx.B!=ndose.B){"
"0","      # (nA, 2:(nB-1))"
"0","      cys <- rbind(tys[(ndose.A-1):ndose.A, (cidx.B-1):(cidx.B+1)], c(NA,NA,NA))"
"0","      cns <- rbind(tns[(ndose.A-1):ndose.A, (cidx.B-1):(cidx.B+1)], c(NA,NA,NA))"
"0","      cover.doses <- rbind(tover.doses[(ndose.A-1):ndose.A, (cidx.B-1):(cidx.B+1)], c(NA,NA,NA))"
"0","    } else if (cidx.A!=ndose.A & cidx.B==ndose.B){"
"0","      # (2:(nA-1), nB)"
"0","      cys <- cbind(tys[(cidx.A-1):(cidx.A+1), (cidx.B-1):cidx.B], c(NA,NA,NA))"
"0","      cns <- cbind(tns[(cidx.A-1):(cidx.A+1), (cidx.B-1):cidx.B], c(NA,NA,NA))"
"0","      cover.doses <- cbind(tover.doses[(cidx.A-1):(cidx.A+1), (cidx.B-1):cidx.B], c(NA,NA,NA))"
"0","    } else {"
"0","      message('no such case')"
"0","    }"
"0","    "
"0","    ###################"
"0","    idx.CFO <- make.decision.2dCFO.fn(phi, cys, cns, add.args$alp.prior, add.args$bet.prior, cover.doses)"
"0","    idx.BOIN <- next.comb(phi, tns, tys, c(cidx.A, cidx.B))$next_dc - c(cidx.A, cidx.B)"
"0","    idx.dfcomb <- CombIncrease_next(ndose.A, ndose.B, phi, target_min=0.2, target_max=0.4, prior_tox_a1, prior_tox_a2, cohortsize, "
"0","                                    final=FALSE, pat_incl=18, dose_adm1=dose1, dose_adm2=dose2, toxicity=toxicity1, c_over=1, "
"0","                                    cmin_overunder=3, cmin_recom=1, early_stop=1, alloc_rule=1) - c(cidx.A, cidx.B)"
"0","    idx.pocrm <- which(a==pocrm.imp(alpha,prior.o,phi,y,combos)$dose.rec, arr.ind = TRUE) - c(cidx.A, cidx.B)"
"0","    "
"0","    A.idx <- c(idx.CFO[1],idx.BOIN[1],idx.dfcomb[1],idx.pocrm[1])"
"0","    B.idx <- c(idx.CFO[2],idx.BOIN[2],idx.dfcomb[2],idx.pocrm[2])"
"0","    "
"0","    cidx.A <- cidx.A + getmode(A.idx)"
"0","    cidx.B <- cidx.B + getmode(B.idx)"
"0","  }"
"0","  "
"0","  if (earlystop==0){"
"0","    MTD <- select.mtd.comb(phi, tns, tys)$MTD"
"0","  }else{"
"0","    MTD <- c(99,99)"
"0","  }"
"0",""
"0","  correct <- 0"
"0","  if(MTD[1]>ndose.A | MTD[2]>ndose.B){"
"0","    correct <- 0"
"0","  } else if (p.true[MTD[1],MTD[2]]==phi){"
"0","    correct <- 1"
"0","  }"
"0",""
"0","  npercent <- 0"
"0","  for (j in 1:ndose.A) {"
"0","    for (k in 1:ndose.B) {"
"0","      if (p.true[j,k]==phi){"
"0","        npercent <- npercent + tns[j,k]"
"0","      }"
"0","    }"
"0","  }"
"0","  npercent <- percent(npercent/(ncohort*cohortsize))"
"0","  list(MTD=MTD, dose.ns=tns, DLT.ns=tys, p.true=p.true, target=phi, over.doses=tover.doses, correct=correct, npercent=npercent, ntox=sum(tys))"
"0","}"
"0",""
